{% extends "base.html" %}
{% block title %}Groq Test | defiv2{% endblock %}

{% block content %}
<div class="text-center">
  <h1 class="display-5">âš¡ Groq Test Dashboard</h1>
  <p class="text-muted">Real-time responses from <code>/groq/test/</code></p>

  <!-- Chart -->
  <canvas id="groqChart" height="120"></canvas>

  <!-- Threshold Input -->
  <div class="row justify-content-center mt-4">
    <div class="col-md-4 d-flex">
      <input type="number" id="threshold" class="form-control" placeholder="Set threshold (e.g. 10)">
      <button class="btn btn-outline-primary ms-2" onclick="updateThreshold()">Apply</button>
    </div>
  </div>

  <!-- Debug -->
  <pre id="groqOutput" class="text-start mt-4 bg-light p-3 border rounded" style="max-height: 300px; overflow:auto;">
  </pre>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let chart;
let thresholdLine = null;

function initChart(){
  const ctx = document.getElementById("groqChart").getContext("2d");
  chart = new Chart(ctx, {
    type: "line",
    data: {
      labels: [],
      datasets: [{
        label: "Groq Response Length",
        data: [],
        borderColor: "blue",
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: { beginAtZero: true }
      },
      plugins: {
        annotation: {
          annotations: {}
        }
      }
    }
  });
}

function updateThreshold(){
  const val = parseInt(document.getElementById("threshold").value);
  if(!isNaN(val)){
    thresholdLine = val;
  }
}

async function pollGroq(){
  try {
    const res = await fetch("/groq/test/");
    const data = await res.json();

    // update debug
    document.getElementById("groqOutput").innerText = JSON.stringify(data, null, 2);

    // update chart with response length
    const len = data.response ? data.response.length : 0;
    chart.data.labels.push(new Date().toLocaleTimeString());
    chart.data.datasets[0].data.push(len);

    // keep only last 20 points
    if(chart.data.labels.length > 20){
      chart.data.labels.shift();
      chart.data.datasets[0].data.shift();
    }

    // draw threshold line
    if(thresholdLine !== null){
      chart.options.plugins.annotation.annotations = {
        line1: {
          type: "line",
          yMin: thresholdLine,
          yMax: thresholdLine,
          borderColor: "red",
          borderWidth: 2,
          label: {
            content: "Threshold",
            enabled: true,
            position: "end"
          }
        }
      };
    }

    chart.update();
  } catch (e) {
    console.error("Groq poll failed", e);
  }
}

initChart();
setInterval(pollGroq, 5000); // poll every 5s
</script>
{% endblock %}
